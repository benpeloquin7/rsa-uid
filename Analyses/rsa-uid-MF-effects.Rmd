---
title: "Rsa-uid4"
author: "Ben"
date: "11/24/2017"
output: html_document
---


```{r packages, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(rwebppl)
library(tidyr)
```


# Questions:
0. Do `speakers` prefer marked utterances to unmarked as a function of need probability (`p(w_i)`)
0. Do `listener` generate an "um" implicature -- interpret an utterance "X" as the high suprisal item.

Parameters
----------
* `model` (S1DV vs L0D vs L2DVVDV, etc.)
* `need probabilities`
* `input` (speakers take worlds, listeners take utterances)
* `theta` noise level


```{r}
modelFile <- "/Users/benpeloquin/Desktop/Projects/rsa_uid/Models/rsa-uid-MF-effects.wppl"
BASE.MODEL <- readChar(modelFile, file.info(modelFile)$size)
```


```{r speakerListenerModelUtils}
modelCombs <- function(prefix, items, n) {
  affixes <- unique(combn(rep(items, n), m=n, FUN=function(x) paste(x, collapse='')))
  sapply(affixes, function(x) paste0(prefix, x))
}

listenerModels <- c(
  modelCombs('L0', c('D', 'V'), 1),
  modelCombs('L1', c('D', 'V'), 3))

speakerModels <- c(
  modelCombs('S1', c('D', 'V'), 2),
  modelCombs('S2', c('D', 'V'), 4))

variableNeedProbs <- "
var worldDistr = Categorical({
  vs:[{color:'a'}, {color:'b'}, {color:'c'}, {color:'d'}, {color:'e'}], 
  ps:[0.1, 0.5, 1, 1, 1]
})
"

uniformNeedProbs <- "
var worldDistr = Categorical({
  vs:[{color:'a'}, {color:'b'}, {color:'c'}, {color:'d'}, {color:'e'}], 
  ps:[1, 1, 1, 1, 1]
})
"
```


# Preference for high semantic suprisal items
```{r}
buildCompleteModel <- function(needProbs) {
  completeModelStr <- paste(needProbs, BASE.MODEL)
  completeModelStr
}

run <- function(modelName, input, needProbs, needType, theta) {
  completeModelStr <- buildCompleteModel(needProbs)
  isSpeakerExp <- unlist(strsplit(modelName, ''))[1] == 'S'
  isVariableNeeds <- needProbs
  rData <- data.frame(modelName=modelName, theta=theta, input=input, isSpeakerExp=isSpeakerExp)
  d <- webppl(completeModelStr, data=rData, data_var='rData') %>%
    mutate(input=input,
           theta=theta,
           modelType=modelName,
           isSpeaker=isSpeakerExp,
           needType=needType)
  d
}
```


```{r experiment1-setup}
runExp1 <- function(modelName) {
  nRuns <- 10
  models <- rep(modelName, nRuns*2)
  inputs <- c(rep('a', nRuns), rep('e', nRuns))
  needProbs <- rep(variableNeedProbs, nRuns*2)
  needProbTypes <- rep('variable', nRuns*2)
  thetas <- rep(seq(0.1, 0.9, length.out=nRuns), 2)
  
  dRuns <- mapply(run, models, inputs, needProbs, needProbTypes, thetas, SIMPLIFY=FALSE)
  df <- do.call(rbind, dRuns)
  rownames(df) <- 1:nrow(df)
  df
}
```

# Do `speakers` prefer marked utterances to unmarked as a function of need probability (`p(w_i)`)
```{r run-experiment1}
df <- runExp1('S1DVD')
```

```{r plot run-experiment1}
df %>%
  mutate(support=as.character(support),
         isMarked=substring(support, 1, 1) == 'X',
         isPrimaryCompare=ifelse(input=='a', support %in% c('X a', 'a'), support %in% c('X e', 'e')),
         supportStr=ifelse(support %in% c('X a', 'a', 'X e', 'e'), support, 'other')) %>%
  group_by(input, theta, supportStr, isMarked, isPrimaryCompare) %>%
  summarise(aggProb=sum(prob)) %>%
  mutate(supportType=ifelse(supportStr %in% c('X a', 'a'), 'a', ifelse(supportStr %in% c('X e', 'e'), 'e', 'other'))) %>%
  ungroup %>%
  # filter(isPrimaryCompare) %>%
ggplot(aes(x=theta, y=aggProb, col=as.factor(supportType), lty=as.factor(isMarked))) +
  geom_line() +
  facet_wrap(~input)
```

```{r run-experimen1-2}
dfS1DD <- runExp1('S1DD')
# dfS1VD <- runExp1('S1VD')
# dfS1VV <- runExp1('S1VV')
# dfS2DVDV <- runExp1('S2DVDV')
# dfS2DDDD <- runExp1('S2DDDD')
# dfS2VVVV <- runExp1('S2VVVV')
dfAgg <- rbind(dfS1DD, dfS1VD, dfS1VV, dfS2DVDV, dfS2DDDD, dfS2VVVV)
```

```{r plot run-experiment1}
dfAgg %>%
  mutate(support=as.character(support),
         isMarked=substring(support, 1, 1) == 'X',
         isPrimaryCompare=ifelse(input=='a', support %in% c('X a', 'a'), support %in% c('X e', 'e')),
         supportStr=ifelse(support %in% c('X a', 'a', 'X e', 'e'), support, 'other')) %>%
  group_by(modelType, input, theta, supportStr, isMarked, isPrimaryCompare) %>%
  summarise(aggProb=sum(prob)) %>%
  mutate(supportType=ifelse(supportStr %in% c('X a', 'a'), 'a', ifelse(supportStr %in% c('X e', 'e'), 'e', 'other'))) %>%
  ungroup %>%
  # filter(isPrimaryCompare) %>%
ggplot(aes(x=theta, y=aggProb, col=as.factor(supportType), lty=as.factor(isMarked))) +
  geom_line() +
  facet_grid(input~modelType)
```
