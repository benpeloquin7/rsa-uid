---
title: "Rsa-uid3"
author: "Ben"
date: "11/20/2017"
output: html_document
---

```{r libraries message=FALSE, warning=FALSE}
library(doParallel)
library(dplyr)
library(ggplot2)
library(lme4)
library(ngram)
library(rwebppl)
library(tidyr)
```

```{r helpers}
annotateUtterance <- function(x) {
  x <- gsub(' ', '', x)
  x <- paste0('^', x)
  x <- paste0(x, '$')
  return(x)
}
  
```


```{r webpplModel}
modelFile <- '/Users/benpeloquin/Desktop/Projects/rsa_uid/Models/rsa-uid-corpus-generation-20171115.wppl'
model <- readChar(modelFile, file.info(modelFile)$size)
```

# Experiment
```{r experimentHelpers}
runExperiment <- function(theta, n, expNum) {
  rData <- data.frame(theta=theta, n=n)
  webpplCorpus <- webppl(model, data=rData, data_var='rData')
  stream <- webpplCorpus %>%
    mutate(annotatedUtterance=annotateUtterance(currUtterance)) %>%
    filter(isSuccess) %>%
    select(annotatedUtterance) %>%
    unlist %>%
    paste(collapse='')
  ng <- ngram(stream, n=2, sep='')  # bigram model
  dfNgramRaw <- data.frame(get.phrasetable(ng))
  dfNgramRaw$first <- sapply(dfNgramRaw$ngrams, function(x) {strsplit(x, '')}[[1]][1])
  dfNgramRaw$second <- sapply(dfNgramRaw$ngrams, function(x) {strsplit(x, '')}[[1]][3])
  dfNgramRaw$theta <- theta
  dfNgramRaw$expNum <- expNum
  return(dfNgramRaw)
}

runExperiments <- function(thetas, ns, expNums) {
  data <- mapply(runExperiment, thetas, ns, expNums, SIMPLIFY=FALSE)
  df <- do.call(rbind, data)
  rownames(df) <- 1:nrow(df)
  return(df)
}
```


```{r simulationSetUp}
# iter=20, n=500, start=8:03, end=8:07
n <- 1000
iters <- 100
#thetas <- c(seq(0.1, 0.9, 0.1))
thetas <- rep(0.9, iters)
expNums <- seq(length(thetas))
ns <- rep(n, length(thetas))
```

```{r runExperiments}
df <- runExperiments(thetas, ns, expNums)
```

```{r plot1}
df %>%
  group_by(theta, expNum, first) %>%
  mutate(first_n=sum(freq),
         postProb=log2(freq/first_n)) %>%
  ungroup %>%
  group_by(theta, expNum, second) %>%
  mutate(second_n=sum(freq),
         likelihood=freq/second_n,
         marked=first=='X') %>%
  ungroup %>%
  filter(second %in% c('r', 'g', 'b', 'y', 'p'), marked) %>%
  select(second, postProb, likelihood) %>%
  group_by(second) %>%
  summarise(
    avgPostProb=mean(postProb),
    xmin=quantile(postProb, probs=c(0.025)),
    xmax=quantile(postProb, probs=c(0.975)),
    avgLikelihood=mean(likelihood),
    ymin=quantile(likelihood, probs=c(0.025)),
    ymax=quantile(likelihood, probs=c(0.975))) %>%
  ggplot(aes(x=avgPostProb, y=avgLikelihood, col=as.factor(second))) +
    geom_point() +
    geom_errorbar(aes(ymax=ymax, ymin=ymin)) +
    geom_errorbarh(aes(xmax=xmax, xmin=xmin))
```


```{r}
df %>%
  group_by(expNum, first) %>%
  mutate(first_n=sum(freq),
         postProb=log2(freq/first_n)) %>%
  ungroup %>%
  group_by(expNum, second) %>%
  mutate(second_n=sum(freq),
         likelihood=freq/second_n,
         marked=first=='X') %>%
  filter(second %in% c('r', 'g', 'b', 'y', 'p'), marked) %>%
  select(theta, second, marked, postProb, likelihood, expNum) %>%
  ggplot(aes(x=postProb, y=likelihood)) +
    geom_point(aes(col=second), alpha=0.7) +
    geom_smooth(method='lm') 
```
```{r}
df %>%
  group_by(expNum, first) %>%
  mutate(first_n=sum(freq),
         postProb=log2(freq/first_n)) %>%
  ungroup %>%
  group_by(expNum, second) %>%
  mutate(second_n=sum(freq),
         likelihood=freq/second_n,
         marked=first=='X') %>%
  filter(second %in% c('r', 'g', 'b', 'y', 'p'), marked) %>%
  select(theta, second, marked, postProb, likelihood, expNum) %>%
  ggplot(aes(x=postProb, y=likelihood)) +
    geom_point(aes(col=second), alpha=0.7) +
    facet_wrap(~expNum) +
    geom_smooth(method='lm')
```

# Run in parallel
```{r runSimulation}
simulateAtTheta <- function(theta) {
  n <- 500
  iters <- 100
  thetas <- rep(theta, iters)
  expNums <- seq(length(thetas))
  ns <- rep(n, length(thetas))
  df <- runExperiments(thetas, ns, expNums)
}

#df <- runExperiments(thetas, ns, expNums)
```

```{r}
no_cores <- detectCores() - 1
registerDoParallel(cores=no_cores) 
cl <- makeCluster(no_cores, type="FORK")
sims <- foreach(i=c(0.1, 0.5, 0.9)) %dopar% simulateAtTheta(i)

dfSims <- do.call(rbind, sims)
```

# Analysis
```{r}
dfAgg <- df %>%
  group_by(expNum, first) %>%
  mutate(first_n=sum(freq),
         postProb=log2(freq/first_n)) %>%
  ungroup %>%
  group_by(expNum, second) %>%
  mutate(second_n=sum(freq),
         likelihood=freq/second_n,
         marked=first=='X') %>%
  filter(second %in% c('r', 'g', 'b', 'y', 'p'), marked) %>%
  select(theta, second, marked, postProb, likelihood, expNum)
```

```{r}
summary(lmer(likelihood~postProb + (expNum|second), data=dfAgg))
```

